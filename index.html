<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMAN 1 PURWANIDA - Sistem Absensi Online</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .main-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        /* Custom styles for the mock logo */
        .school-logo {
            font-size: 2.5rem;
            font-weight: 800;
            color: #1e40af; /* Blue-800 */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .school-name {
            font-size: 1.25rem;
            color: #374151; /* Gray-700 */
        }
        /* Style for active button/tab */
        .tab-active {
            border-bottom: 3px solid #10b981; /* Emerald-500 */
            color: #059669; /* Emerald-600 */
            font-weight: 600;
        }
        /* Custom styles for responsive table layout */
        .responsive-table th, .responsive-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        @media (max-width: 768px) {
            .responsive-table thead {
                display: none;
            }
            .responsive-table tbody, .responsive-table tr, .responsive-table td {
                display: block;
                width: 100%;
            }
            .responsive-table tr {
                margin-bottom: 1rem;
                border: 1px solid #d1d5db;
                border-radius: 0.5rem;
                padding: 1rem;
            }
            .responsive-table td {
                text-align: right;
                padding: 0.5rem 0;
            }
            .responsive-table td::before {
                content: attr(data-label);
                float: left;
                font-weight: 600;
                text-transform: uppercase;
                margin-right: 1rem;
            }
        }
    </style>
    <!-- Load jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="main-container">
        <!-- Main Header -->
        <header id="header" class="w-full shadow-lg bg-white p-4 sticky top-0 z-10 flex flex-col items-center">
            <div class="flex items-center space-x-3 mb-1">
                <span class="school-logo">S1P</span>
                <span class="school-name">SMAN 1 PURWANIDA</span>
            </div>
            <p id="app-subtitle" class="text-sm text-gray-500"></p>
        </header>

        <!-- Main Content Area -->
        <main class="w-full max-w-6xl p-4 md:p-8 flex-grow">
            <!-- Dynamic content will be rendered here -->
            <div id="content" class="w-full">
                <!-- Content injected by JavaScript -->
            </div>
        </main>

        <!-- Footer for Logout/User Info -->
        <footer id="footer" class="w-full bg-gray-100 p-4 border-t border-gray-200 text-center text-sm text-gray-600">
            <div id="user-info" class="max-w-6xl mx-auto flex justify-between items-center">
                <!-- User info and Logout button injected here -->
            </div>
        </footer>

        <!-- Modal Placeholder -->
        <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
            <div id="modal-content" class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full transform transition-all">
                <!-- Modal content injected here -->
            </div>
        </div>
    </div>

    <script>
        // --- Konstanta dan Inisialisasi Lokal ---
        const APP_NAME = "SMAN 1 PURWANIDA";
        const LOCAL_STORAGE_KEY = 'absensi_app_data';
        const MOCK_SALT = 'SMAN1PURWANIDA-SALT';
        const TOKEN_EXPIRY_HOURS = 1;
        
        let state = {
            currentUser: null,
            users: [],
            classes: [],
            attendance: [],
            currentFilter: { classId: null, month: new Date().toISOString().substring(0, 7) }
        };

        // --- Simulasi Keamanan (MOCK: Bukan untuk produksi!) ---

        /**
         * Simulates Bcrypt hashing using a simple Base64 + Salt.
         * Tujuannya hanya untuk memenuhi persyaratan penyimpanan password terenkripsi (simulasi).
         * @param {string} password
         */
        const mockHashPassword = (password) => {
            return btoa(password + MOCK_SALT);
        };

        /**
         * Simulates Bcrypt password verification.
         * @param {string} inputPassword
         * @param {string} storedHash
         */
        const mockCheckPassword = (inputPassword, storedHash) => {
            return mockHashPassword(inputPassword) === storedHash;
        };

        /**
         * Simulates JWT creation. Token adalah object yang disimpan di localStorage.
         * @param {object} user
         */
        const createMockToken = (user) => {
            const expiry = new Date();
            expiry.setHours(expiry.getHours() + TOKEN_EXPIRY_HOURS);
            return {
                userId: user.id,
                role: user.role,
                exp: expiry.getTime(),
                user
            };
        };

        /**
         * Mengambil data dari localStorage.
         */
        const loadData = () => {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                state = JSON.parse(storedData);
            } else {
                // Initial Mock Data
                state.classes = [
                    { id: 'c10A', name: 'Kelas XA' },
                    { id: 'c10B', name: 'Kelas XB' }
                ];
                
                state.users = [
                    // Admin
                    { id: 'u000', username: 'admin', passwordHash: mockHashPassword('admin123'), role: 'admin', classId: null, fullName: 'Super Admin Sekolah' },
                    // Wali Kelas
                    { id: 'u100', username: 'wali_10a', passwordHash: mockHashPassword('wali123'), role: 'wali', classId: 'c10A', fullName: 'Budi Santoso' },
                    // Siswa Kelas XA
                    { id: 'u101', username: 'siswa_10a_01', passwordHash: mockHashPassword('siswa123'), role: 'siswa', classId: 'c10A', fullName: 'Andi Pratama', nis: '2024001' },
                    { id: 'u102', username: 'siswa_10a_02', passwordHash: mockHashPassword('siswi456'), role: 'siswa', classId: 'c10A', fullName: 'Dewi Lestari', nis: '2024002' },
                    // Siswa Kelas XB
                    { id: 'u201', username: 'siswa_10b_01', passwordHash: mockHashPassword('siswa999'), role: 'siswa', classId: 'c10B', fullName: 'Joko Widodo', nis: '2024101' },
                ];
                saveData();
            }

            // Set default filter if not set
            if (!state.currentFilter.classId && state.currentUser && state.currentUser.role === 'wali') {
                 state.currentFilter.classId = state.currentUser.classId;
            }
        };

        /**
         * Menyimpan data ke localStorage.
         */
        const saveData = () => {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
        };

        // --- Fungsi Helper UI ---

        const getRoleName = (role) => {
            const map = {
                'admin': 'Admin Sekolah',
                'wali': 'Wali Kelas',
                'siswa': 'Siswa'
            };
            return map[role] || role;
        };

        const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;

        const showModal = (title, bodyHtml) => {
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">${title}</h3>
                    <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div>${bodyHtml}</div>
            `;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
        };

        const hideModal = () => {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.add('hidden');
            modalContainer.classList.remove('flex');
        };

        const showMessage = (type, message) => {
            const colorMap = {
                success: 'bg-green-100 text-green-700 border-green-400',
                error: 'bg-red-100 text-red-700 border-red-400',
                info: 'bg-blue-100 text-blue-700 border-blue-400'
            };
            const messageEl = document.createElement('div');
            messageEl.className = `p-3 mb-4 rounded-lg border ${colorMap[type] || colorMap.info} text-sm font-medium`;
            messageEl.textContent = message;
            document.getElementById('content').prepend(messageEl);
            setTimeout(() => messageEl.remove(), 5000);
        };

        // --- Logika Autentikasi ---

        const checkAuthentication = () => {
            const token = JSON.parse(localStorage.getItem('user_token'));
            if (token && token.exp > Date.now()) {
                state.currentUser = state.users.find(u => u.id === token.userId);
                if (state.currentUser) {
                    renderApp();
                    return true;
                }
            }
            localStorage.removeItem('user_token');
            state.currentUser = null;
            renderLogin();
            return false;
        };

        const handleLogin = () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const user = state.users.find(u => u.username === username);

            if (user && mockCheckPassword(password, user.passwordHash)) {
                const token = createMockToken(user);
                localStorage.setItem('user_token', JSON.stringify(token));
                state.currentUser = user;
                showMessage('success', `Selamat datang, ${user.fullName}!`);
                renderApp();
            } else {
                showMessage('error', 'Username atau password salah.');
            }
        };

        const handleLogout = () => {
            localStorage.removeItem('user_token');
            state.currentUser = null;
            showMessage('info', 'Anda telah berhasil logout.');
            renderLogin();
        };


        // --- Render Halaman (Routing) ---

        const renderLogin = () => {
            document.getElementById('app-subtitle').textContent = 'Silahkan Login untuk Mengakses Sistem';
            document.getElementById('footer').classList.add('hidden');
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <div class="flex justify-center items-center py-10">
                    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Login</h2>
                        
                        <div class="mb-4">
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                            <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="Masukkan Username">
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="Masukkan Password">
                        </div>
                        
                        <button onclick="handleLogin()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2.5 rounded-lg transition duration-200 shadow-lg shadow-emerald-200">
                            Masuk
                        </button>

                        <p class="mt-6 text-center text-xs text-gray-500">
                            * Demo Users: Admin (admin/admin123), Wali (wali_10a/wali123), Siswa (siswa_10a_01/siswa123)
                        </p>
                    </div>
                </div>
            `;
        };

        const renderApp = () => {
            const user = state.currentUser;
            document.getElementById('app-subtitle').textContent = `Dashboard ${getRoleName(user.role)}`;
            document.getElementById('footer').classList.remove('hidden');
            
            // Render Footer
            document.getElementById('user-info').innerHTML = `
                <span class="font-medium text-gray-800">Hi, ${user.fullName} (${getRoleName(user.role)})</span>
                <button onclick="handleLogout()" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm font-semibold rounded-lg transition duration-200">
                    Logout
                </button>
            `;
            
            // Render Main Content
            if (user.role === 'siswa') {
                renderSiswaDashboard();
            } else if (user.role === 'wali') {
                renderWaliDashboard();
            } else if (user.role === 'admin') {
                renderAdminDashboard();
            }
        };

        // --- Siswa Features ---

        const renderSiswaDashboard = () => {
            document.getElementById('content').innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Dashboard Siswa</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Presensi Harian</h3>
                        <p class="text-sm text-gray-500 mb-4">Hari ini: ${new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <div id="checkin-status" class="mb-4"></div>
                        <button id="check-in-btn" onclick="openCheckinModal()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-lg shadow-blue-200 flex items-center justify-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                            <span>Check-in Sekarang</span>
                        </button>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Informasi Saya</h3>
                        <p class="text-gray-600"><span class="font-medium">Nama:</span> ${state.currentUser.fullName}</p>
                        <p class="text-gray-600"><span class="font-medium">NIS:</span> ${state.currentUser.nis}</p>
                        <p class="text-gray-600"><span class="font-medium">Kelas:</span> ${state.classes.find(c => c.id === state.currentUser.classId)?.name || '-'}</p>
                    </div>
                </div>

                <div class="mt-8 bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Riwayat Presensi</h3>
                    ${renderSiswaHistoryTable()}
                </div>
            `;
            checkDailyCheckinStatus();
        };

        const checkDailyCheckinStatus = () => {
            const today = new Date().toISOString().split('T')[0];
            const hasCheckedIn = state.attendance.some(
                a => a.userId === state.currentUser.id && a.date === today
            );
            const statusEl = document.getElementById('checkin-status');
            const checkinBtn = document.getElementById('check-in-btn');

            if (hasCheckedIn) {
                statusEl.innerHTML = '<div class="p-3 bg-emerald-100 text-emerald-700 rounded-lg font-medium">Anda sudah presensi hari ini. Status: **' + state.attendance.find(a => a.userId === state.currentUser.id && a.date === today).status + '**</div>';
                checkinBtn.disabled = true;
                checkinBtn.classList.add('opacity-50', 'cursor-not-allowed');
                checkinBtn.classList.remove('hover:bg-blue-600');
            } else {
                statusEl.innerHTML = '<div class="p-3 bg-yellow-100 text-yellow-700 rounded-lg font-medium">Anda belum presensi hari ini.</div>';
                checkinBtn.disabled = false;
                checkinBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                checkinBtn.classList.add('hover:bg-blue-600');
            }
        };
        
        const openCheckinModal = () => {
            const today = new Date().toISOString().split('T')[0];
            const modalBody = `
                <div id="checkin-alert"></div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status Kehadiran</label>
                    <select id="presensi-status" onchange="toggleReasonField(this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="Hadir">Hadir (Check-in)</option>
                        <option value="Izin">Izin</option>
                        <option value="Sakit">Sakit</option>
                        <option value="Alfa">Alfa (Hanya Admin/Wali yang bisa set)</option>
                    </select>
                </div>
                <div id="reason-field" class="mb-4 hidden">
                    <label for="presensi-reason" class="block text-sm font-medium text-gray-700 mb-1">Alasan Izin/Sakit</label>
                    <textarea id="presensi-reason" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="Jelaskan alasan Anda"></textarea>
                </div>
                <button onclick="handleCheckin('${today}')" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2.5 rounded-lg transition duration-200">
                    Konfirmasi Presensi
                </button>
            `;
            showModal('Check-in Presensi Harian', modalBody);

            // Default status is 'Hadir', so hide reason field
            document.getElementById('presensi-status').value = 'Hadir';
            document.getElementById('reason-field').classList.add('hidden');
        };

        const toggleReasonField = (status) => {
            const reasonField = document.getElementById('reason-field');
            if (status === 'Izin' || status === 'Sakit') {
                reasonField.classList.remove('hidden');
            } else {
                reasonField.classList.add('hidden');
            }
        };

        const handleCheckin = (date) => {
            const status = document.getElementById('presensi-status').value;
            const reason = document.getElementById('presensi-reason')?.value || '';
            const checkinAlert = document.getElementById('checkin-alert');

            if ((status === 'Izin' || status === 'Sakit') && !reason) {
                checkinAlert.innerHTML = '<div class="p-3 mb-4 bg-red-100 text-red-700 rounded-lg font-medium">Mohon isi alasan untuk status Izin/Sakit.</div>';
                return;
            }

            // Only Admin/Wali can set Alfa
            if (status === 'Alfa') {
                checkinAlert.innerHTML = '<div class="p-3 mb-4 bg-red-100 text-red-700 rounded-lg font-medium">Status Alfa hanya dapat diatur oleh Admin atau Wali Kelas.</div>';
                return;
            }

            // Get GPS Location (Optional)
            const time = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            let location = 'Lokasi tidak tersedia (Izin pengguna ditolak/tidak diminta)';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        location = `Lat: ${position.coords.latitude.toFixed(4)}, Lon: ${position.coords.longitude.toFixed(4)}`;
                        saveAttendance(date, time, status, reason, location);
                        hideModal();
                        showMessage('success', `Presensi **${status}** berhasil dicatat.`);
                        renderSiswaDashboard(); // Re-render to update status
                    },
                    (error) => {
                        // If geolocation fails or permission is denied, save with default location
                        saveAttendance(date, time, status, reason, location);
                        hideModal();
                        showMessage('success', `Presensi **${status}** berhasil dicatat (tanpa lokasi GPS).`);
                        renderSiswaDashboard(); // Re-render to update status
                    }
                );
            } else {
                saveAttendance(date, time, status, reason, location);
                hideModal();
                showMessage('success', `Presensi **${status}** berhasil dicatat (Peramban tidak mendukung GPS).`);
                renderSiswaDashboard(); // Re-render to update status
            }
        };

        const saveAttendance = (date, time, status, reason, location) => {
             const newRecord = {
                id: generateId(),
                userId: state.currentUser.id,
                date: date,
                time: time,
                status: status,
                reason: reason,
                location: location,
                editor: state.currentUser.fullName // Catat siapa yang membuat
            };
            state.attendance.push(newRecord);
            saveData();
        };

        const renderSiswaHistoryTable = () => {
            const history = state.attendance
                .filter(a => a.userId === state.currentUser.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (history.length === 0) {
                return '<p class="text-gray-500 italic">Belum ada riwayat presensi yang tercatat.</p>';
            }

            return `
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="w-full responsive-table bg-white">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Tanggal</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Waktu</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Status</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Alasan/Catatan</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${history.map(a => `
                                <tr>
                                    <td data-label="Tanggal" class="font-medium text-gray-800">${a.date}</td>
                                    <td data-label="Waktu">${a.time}</td>
                                    <td data-label="Status">
                                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                            a.status === 'Hadir' ? 'bg-emerald-100 text-emerald-800' :
                                            a.status === 'Izin' ? 'bg-yellow-100 text-yellow-800' :
                                            a.status === 'Sakit' ? 'bg-orange-100 text-orange-800' :
                                            'bg-red-100 text-red-800'
                                        }">
                                            ${a.status}
                                        </span>
                                    </td>
                                    <td data-label="Alasan/Catatan" class="text-sm text-gray-600">${a.reason || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        };

        // --- Wali Kelas Features ---

        const renderWaliDashboard = () => {
            const classUser = state.classes.find(c => c.id === state.currentUser.classId);
            
            document.getElementById('content').innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Dashboard Wali Kelas</h2>
                <div class="bg-blue-50 p-4 rounded-xl mb-6 shadow-md border border-blue-100">
                    <p class="text-lg font-semibold text-blue-800">Kelas yang Anda Ajar: **${classUser?.name || 'Tidak Ditemukan'}**</p>
                </div>

                <!-- Filter and Download Controls -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-6 flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-grow w-full">
                        <label for="filter-month" class="block text-sm font-medium text-gray-700 mb-1">Filter Bulan (Bisa Filter Harian, Mingguan, Bulanan)</label>
                        <input type="month" id="filter-month" value="${state.currentFilter.month}" onchange="updateWaliFilter('month', this.value)" class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <button onclick="downloadReport('pdf')" class="w-full md:w-auto bg-red-600 hover:bg-red-700 text-white font-semibold py-2.5 px-5 rounded-lg transition duration-200 flex items-center justify-center space-x-2 shadow-md">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13l-3 3m0 0l-3-3m3 3V8m0 13a9 9 0 110-18 9 9 0 010 18z"></path></svg>
                        <span>Unduh PDF</span>
                    </button>
                    <button onclick="downloadReport('csv')" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-5 rounded-lg transition duration-200 flex items-center justify-center space-x-2 shadow-md">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span>Unduh CSV</span>
                    </button>
                </div>

                <!-- Rekap Absensi Table -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Rekap Kehadiran Kelas ${classUser?.name} (${state.currentFilter.month})</h3>
                    <div id="rekap-absensi">
                        ${renderWaliClassAttendance()}
                    </div>
                </div>
            `;
        };

        const updateWaliFilter = (key, value) => {
            state.currentFilter[key] = value;
            saveData();
            renderWaliDashboard();
        };

        const renderWaliClassAttendance = () => {
            const classId = state.currentUser.classId;
            const studentsInClass = state.users.filter(u => u.role === 'siswa' && u.classId === classId);
            const classAttendance = state.attendance.filter(a => studentsInClass.some(s => s.id === a.userId));
            const filterMonth = state.currentFilter.month;

            // Filter attendance records by month
            const filteredAttendance = classAttendance.filter(a => a.date.startsWith(filterMonth));
            
            // Group and summarize
            const summary = studentsInClass.map(student => {
                const records = filteredAttendance.filter(a => a.userId === student.id);
                const counts = records.reduce((acc, curr) => {
                    acc[curr.status] = (acc[curr.status] || 0) + 1;
                    return acc;
                }, { Hadir: 0, Izin: 0, Sakit: 0, Alfa: 0 });
                return {
                    ...student,
                    counts,
                    records
                };
            });

            if (summary.length === 0) {
                return '<p class="text-gray-500 italic">Tidak ada data siswa dalam kelas ini atau belum ada presensi di bulan ini.</p>';
            }
            
            return `
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table id="attendance-recap-table" class="w-full responsive-table bg-white">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Nama Siswa</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600 text-center">Hadir</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600 text-center">Izin</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600 text-center">Sakit</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600 text-center">Alfa</th>
                                <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${summary.map(s => `
                                <tr>
                                    <td data-label="Nama Siswa" class="font-medium text-gray-800">${s.fullName}</td>
                                    <td data-label="Hadir" class="text-center">${s.counts.Hadir}</td>
                                    <td data-label="Izin" class="text-center">${s.counts.Izin}</td>
                                    <td data-label="Sakit" class="text-center">${s.counts.Sakit}</td>
                                    <td data-label="Alfa" class="text-center text-red-600 font-bold">${s.counts.Alfa}</td>
                                    <td data-label="Aksi" class="space-x-2 flex justify-end md:justify-start mt-2 md:mt-0">
                                        <button onclick="openEditAttendanceModal('${s.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                            Edit/Lihat Detail
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        };
        
        const openEditAttendanceModal = (studentId) => {
            const student = state.users.find(u => u.id === studentId);
            const records = state.attendance
                .filter(a => a.userId === studentId && a.date.startsWith(state.currentFilter.month))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const classObj = state.classes.find(c => c.id === student.classId);

            const recordRows = records.map(a => `
                <tr id="record-row-${a.id}">
                    <td class="px-4 py-2">${a.date} (${a.time})</td>
                    <td class="px-4 py-2">${a.status}</td>
                    <td class="px-4 py-2 text-sm">${a.reason || '-'}</td>
                    <td class="px-4 py-2">
                        <button onclick="editSingleRecord('${a.id}', '${student.fullName}')" class="text-emerald-500 hover:text-emerald-700 text-sm font-medium mr-2">Edit</button>
                        <button onclick="deleteSingleRecord('${a.id}')" class="text-red-500 hover:text-red-700 text-sm font-medium">Hapus</button>
                    </td>
                </tr>
            `).join('');

            const modalBody = `
                <p class="text-base text-gray-600 mb-4">Kelas: ${classObj?.name || '-'}</p>
                <h4 class="text-lg font-semibold text-gray-700 mb-3">Tambah Catatan Baru</h4>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="new-date" class="block text-xs font-medium text-gray-700">Tanggal</label>
                        <input type="date" id="new-date" value="${new Date().toISOString().split('T')[0]}" class="w-full px-3 py-1 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="new-status" class="block text-xs font-medium text-gray-700">Status</label>
                        <select id="new-status" class="w-full px-3 py-1 border border-gray-300 rounded-lg">
                            <option value="Hadir">Hadir</option>
                            <option value="Izin">Izin</option>
                            <option value="Sakit">Sakit</option>
                            <option value="Alfa">Alfa</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="new-reason" class="block text-xs font-medium text-gray-700">Alasan/Catatan</label>
                    <textarea id="new-reason" rows="2" class="w-full px-3 py-1 border border-gray-300 rounded-lg"></textarea>
                </div>
                <button onclick="addAttendanceRecord('${studentId}')" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg transition duration-200 mb-6">
                    Tambahkan Catatan
                </button>

                <h4 class="text-lg font-semibold text-gray-700 mb-3 border-t pt-4">Riwayat Bulan Ini (${records.length} Catatan)</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">Tanggal/Waktu</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">Status</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">Alasan</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recordRows || '<tr><td colspan="4" class="text-center py-4 text-gray-500 italic">Belum ada catatan presensi di bulan ini.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            showModal(`Edit Presensi Siswa: ${student.fullName}`, modalBody);
        };

        const addAttendanceRecord = (userId) => {
            const date = document.getElementById('new-date').value;
            const status = document.getElementById('new-status').value;
            const reason = document.getElementById('new-reason').value;
            const student = state.users.find(u => u.id === userId);

            if (!date || !status) {
                showMessage('error', 'Tanggal dan Status wajib diisi.');
                return;
            }
            
            // Check for existing record on the same date
            const existing = state.attendance.some(a => a.userId === userId && a.date === date);
            if (existing) {
                 showMessage('error', 'Catatan presensi untuk siswa ini pada tanggal tersebut sudah ada. Silahkan gunakan tombol Edit.');
                 return;
            }

            const newRecord = {
                id: generateId(),
                userId: userId,
                date: date,
                time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                status: status,
                reason: reason,
                location: `Diinput oleh ${state.currentUser.fullName} (${getRoleName(state.currentUser.role)})`,
                editor: state.currentUser.fullName
            };

            state.attendance.push(newRecord);
            saveData();
            hideModal();
            showMessage('success', `Catatan presensi untuk ${student.fullName} berhasil ditambahkan.`);
            renderWaliDashboard();
        };

        const editSingleRecord = (recordId, studentName) => {
             const record = state.attendance.find(a => a.id === recordId);
             if (!record) return;

             const modalBody = `
                <div class="mb-4">
                    <label for="edit-status" class="block text-sm font-medium text-gray-700 mb-1">Status Kehadiran</label>
                    <select id="edit-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="Hadir" ${record.status === 'Hadir' ? 'selected' : ''}>Hadir</option>
                        <option value="Izin" ${record.status === 'Izin' ? 'selected' : ''}>Izin</option>
                        <option value="Sakit" ${record.status === 'Sakit' ? 'selected' : ''}>Sakit</option>
                        <option value="Alfa" ${record.status === 'Alfa' ? 'selected' : ''}>Alfa</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="edit-reason" class="block text-sm font-medium text-gray-700 mb-1">Alasan/Catatan</label>
                    <textarea id="edit-reason" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg">${record.reason || ''}</textarea>
                </div>
                <p class="text-xs text-gray-500 mb-4">Tanggal Presensi: ${record.date} | Lokasi Catatan: ${record.location}</p>
                <button onclick="updateAttendanceRecord('${recordId}', '${studentName}')" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2.5 rounded-lg transition duration-200">
                    Simpan Perubahan
                </button>
                <button onclick="openEditAttendanceModal('${record.userId}')" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2.5 rounded-lg transition duration-200">
                    Batal (Kembali ke Daftar)
                </button>
             `;
             showModal(`Edit Catatan Presensi: ${studentName} (${record.date})`, modalBody);
        };

        const updateAttendanceRecord = (recordId, studentName) => {
            const index = state.attendance.findIndex(a => a.id === recordId);
            if (index === -1) return;

            state.attendance[index].status = document.getElementById('edit-status').value;
            state.attendance[index].reason = document.getElementById('edit-reason').value;
            state.attendance[index].editor = state.currentUser.fullName; // Update editor info
            saveData();
            hideModal();
            showMessage('success', `Catatan presensi untuk ${studentName} berhasil diubah.`);
            renderWaliDashboard();
        };
        
        const deleteSingleRecord = (recordId) => {
            const index = state.attendance.findIndex(a => a.id === recordId);
            if (index === -1) return;

            showModal('Konfirmasi Hapus', `
                <p class="mb-4">Apakah Anda yakin ingin menghapus catatan presensi ini? Tindakan ini tidak dapat dibatalkan.</p>
                <button onclick="confirmDeleteRecord('${recordId}')" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 px-4 rounded-lg mr-2">Ya, Hapus</button>
                <button onclick="hideModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2.5 px-4 rounded-lg">Batal</button>
            `);
        };

        const confirmDeleteRecord = (recordId) => {
            const index = state.attendance.findIndex(a => a.id === recordId);
            if (index !== -1) {
                const studentId = state.attendance[index].userId;
                state.attendance.splice(index, 1);
                saveData();
                hideModal();
                showMessage('info', 'Catatan presensi berhasil dihapus.');
                openEditAttendanceModal(studentId); // Reopen the detail modal
            }
        }

        // --- Laporan Downloads ---
        
        const downloadReport = (format) => {
            const classUser = state.classes.find(c => c.id === state.currentUser.classId);
            const classId = state.currentUser.classId;
            const studentsInClass = state.users.filter(u => u.role === 'siswa' && u.classId === classId);
            const classAttendance = state.attendance.filter(a => studentsInClass.some(s => s.id === a.userId));
            const filterMonth = state.currentFilter.month;
            const filteredAttendance = classAttendance.filter(a => a.date.startsWith(filterMonth));

            const summary = studentsInClass.map(student => {
                const records = filteredAttendance.filter(a => a.userId === student.id);
                const counts = records.reduce((acc, curr) => {
                    acc[curr.status] = (acc[curr.status] || 0) + 1;
                    return acc;
                }, { Hadir: 0, Izin: 0, Sakit: 0, Alfa: 0 });
                return {
                    Nama: student.fullName,
                    NIS: student.nis || '-',
                    Kelas: classUser.name,
                    Hadir: counts.Hadir,
                    Izin: counts.Izin,
                    Sakit: counts.Sakit,
                    Alfa: counts.Alfa,
                    TotalCatatan: records.length
                };
            });

            if (summary.length === 0) {
                 showMessage('error', 'Tidak ada data untuk diunduh berdasarkan filter saat ini.');
                 return;
            }

            const filename = `Rekap_Absensi_${classUser.name}_${filterMonth}`;

            if (format === 'csv') {
                convertToCSV(summary, filename + '.csv');
            } else if (format === 'pdf') {
                convertToPDF(summary, filename + '.pdf', classUser.name, filterMonth);
            }
        };

        const convertToCSV = (data, filename) => {
            const headers = Object.keys(data[0]);
            const rows = data.map(obj => headers.map(header => JSON.stringify(obj[header])).join(','));
            
            const csvContent = [
                headers.join(','),
                ...rows
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage('success', 'Laporan CSV berhasil diunduh!');
            }
        };
        
        const convertToPDF = (data, filename, className, filterMonth) => {
             // window.jsPDF is available via CDN
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const title = `REKAPITULASI ABSENSI SISWA - ${APP_NAME}`;
            const subtitle = `Kelas: ${className} | Periode: ${filterMonth}`;
            
            doc.setFontSize(16);
            doc.text(title, doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text(subtitle, doc.internal.pageSize.getWidth() / 2, 25, { align: 'center' });
            
            const tableHeaders = Object.keys(data[0]);
            const tableData = data.map(obj => Object.values(obj));

            doc.autoTable({
                startY: 35,
                head: [tableHeaders],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [30, 64, 175] }, // Blue-700
                styles: { font: 'helvetica', fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    // Set widths if necessary
                }
            });

            doc.save(filename);
            showMessage('success', 'Laporan PDF berhasil diunduh!');
        };


        // --- Admin Features ---

        const renderAdminDashboard = () => {
            document.getElementById('content').innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Dashboard Admin</h2>
                <div class="flex space-x-4 mb-6 border-b border-gray-200">
                    <button onclick="renderAdminSection('users')" id="tab-users" class="p-3 text-gray-600 hover:text-emerald-600 transition-colors tab-active">Kelola Pengguna</button>
                    <button onclick="renderAdminSection('classes')" id="tab-classes" class="p-3 text-gray-600 hover:text-emerald-600 transition-colors">Kelola Kelas</button>
                    <button onclick="renderAdminSection('absensi')" id="tab-absensi" class="p-3 text-gray-600 hover:text-emerald-600 transition-colors">Semua Rekap Absensi</button>
                </div>
                
                <div id="admin-section">
                    ${renderAdminUsers()}
                </div>
            `;
        };

        const renderAdminSection = (section) => {
            // Clear active tab
            document.querySelectorAll('.border-b-2').forEach(el => el.classList.remove('tab-active'));
            document.getElementById(`tab-${section}`).classList.add('tab-active');

            const sectionEl = document.getElementById('admin-section');
            if (section === 'users') {
                sectionEl.innerHTML = renderAdminUsers();
            } else if (section === 'classes') {
                sectionEl.innerHTML = renderAdminClasses();
            } else if (section === 'absensi') {
                sectionEl.innerHTML = renderAdminAllAttendance();
            }
        };

        const renderAdminUsers = () => {
            const users = state.users.filter(u => u.role !== 'admin').sort((a, b) => a.role.localeCompare(b.role) || a.fullName.localeCompare(b.fullName));

            const userRows = users.map(u => {
                const classObj = state.classes.find(c => c.id === u.classId);
                return `
                    <tr>
                        <td data-label="Nama" class="font-medium text-gray-800">${u.fullName}</td>
                        <td data-label="Username">${u.username}</td>
                        <td data-label="Role">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                u.role === 'siswa' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'
                            }">
                                ${getRoleName(u.role)}
                            </span>
                        </td>
                        <td data-label="Kelas/NIP">${u.role === 'siswa' ? u.nis : (classObj ? classObj.name : '-')}</td>
                        <td data-label="Aksi" class="space-x-2 flex justify-end md:justify-start mt-2 md:mt-0">
                            <button onclick="openEditUserModal('${u.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
                            <button onclick="deleteUser('${u.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Daftar Pengguna (Siswa & Wali Kelas)</h3>
                    <button onclick="openEditUserModal(null)" class="mb-4 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 flex items-center space-x-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        <span>Tambah Pengguna Baru</span>
                    </button>
                    
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="w-full responsive-table bg-white">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Nama Lengkap</th>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Username</th>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Role</th>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">ID (NIS/Kelas Wali)</th>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${userRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        const openEditUserModal = (userId) => {
            const user = state.users.find(u => u.id === userId) || {};
            const isNew = !userId;
            const classOptions = state.classes.map(c => 
                `<option value="${c.id}" ${user.classId === c.id ? 'selected' : ''}>${c.name}</option>`
            ).join('');

            const title = isNew ? 'Tambah Pengguna Baru' : `Edit Pengguna: ${user.fullName}`;
            
            const modalBody = `
                <div class="mb-4">
                    <label for="edit-role" class="block text-sm font-medium text-gray-700 mb-1">Role Pengguna</label>
                    <select id="edit-role" onchange="toggleUserFields(this.value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="siswa" ${user.role === 'siswa' ? 'selected' : ''}>Siswa</option>
                        <option value="wali" ${user.role === 'wali' ? 'selected' : ''}>Wali Kelas</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''} ${!isNew && user.role === 'admin' ? 'disabled' : ''}>Admin</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="edit-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="edit-name" value="${user.fullName || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                <div class="mb-4">
                    <label for="edit-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="edit-username" value="${user.username || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" ${!isNew ? 'disabled' : ''}>
                    ${!isNew ? '<p class="text-xs text-gray-500 mt-1">Username tidak dapat diubah.</p>' : ''}
                </div>
                <div id="siswa-field" class="mb-4" style="display: ${user.role === 'siswa' ? 'block' : 'none'};">
                    <label for="edit-nis" class="block text-sm font-medium text-gray-700 mb-1">NIS (Nomor Induk Siswa)</label>
                    <input type="text" id="edit-nis" value="${user.nis || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                <div id="class-field" class="mb-4" style="display: ${user.role === 'siswa' || user.role === 'wali' ? 'block' : 'none'};">
                    <label for="edit-class" class="block text-sm font-medium text-gray-700 mb-1">Kelas Dikelola/Diikuti</label>
                    <select id="edit-class" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">-- Pilih Kelas --</option>
                        ${classOptions}
                    </select>
                </div>
                ${isNew ? `
                    <div class="mb-4">
                        <label for="edit-password" class="block text-sm font-medium text-gray-700 mb-1">Password (Baru)</label>
                        <input type="password" id="edit-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Isi hanya untuk pengguna baru">
                    </div>
                ` : `
                    <p class="text-sm text-gray-700 mb-4">Kosongkan kolom password di bawah jika tidak ingin mengubah.</p>
                    <div class="mb-4">
                        <label for="edit-password-update" class="block text-sm font-medium text-gray-700 mb-1">Ganti Password</label>
                        <input type="password" id="edit-password-update" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Masukkan password baru">
                    </div>
                `}
                <button onclick="saveUser('${userId}', ${isNew})" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2.5 rounded-lg transition duration-200">
                    ${isNew ? 'Tambah Pengguna' : 'Simpan Perubahan'}
                </button>
            `;
            showModal(title, modalBody);

            // Ensure field visibility is correct on load
            document.getElementById('edit-role').onchange();
        };

        const toggleUserFields = (role) => {
            document.getElementById('siswa-field').style.display = role === 'siswa' ? 'block' : 'none';
            document.getElementById('class-field').style.display = role === 'siswa' || role === 'wali' ? 'block' : 'none';
        };

        const saveUser = (userId, isNew) => {
            const role = document.getElementById('edit-role').value;
            const fullName = document.getElementById('edit-name').value;
            const username = document.getElementById('edit-username').value;
            const classId = document.getElementById('edit-class').value || null;
            const nis = document.getElementById('edit-nis')?.value || null;
            const passwordFieldId = isNew ? 'edit-password' : 'edit-password-update';
            const password = document.getElementById(passwordFieldId)?.value;

            if (!fullName || !username) {
                showMessage('error', 'Nama lengkap dan Username wajib diisi.');
                return;
            }
            if (isNew && !password) {
                 showMessage('error', 'Password wajib diisi untuk pengguna baru.');
                 return;
            }
            if (!isNew && role === 'admin' && state.users.find(u => u.id === userId).role !== 'admin') {
                // Prevent demoting non-admin users to admin through this simple modal
                // For this simulation, we'll allow it but advise caution.
                showMessage('info', 'Mengubah role ke Admin dilakukan, namun berhati-hatilah dengan perubahan role.');
            }
            if (role === 'siswa' && !nis) {
                showMessage('error', 'NIS wajib diisi untuk Siswa.');
                return;
            }
            if ((role === 'siswa' || role === 'wali') && !classId) {
                showMessage('error', 'Kelas wajib dipilih untuk Siswa dan Wali Kelas.');
                return;
            }

            if (isNew) {
                if (state.users.some(u => u.username === username)) {
                    showMessage('error', 'Username sudah digunakan.');
                    return;
                }
                const newUser = {
                    id: generateId(),
                    username,
                    passwordHash: mockHashPassword(password),
                    role,
                    fullName,
                    classId,
                    nis: role === 'siswa' ? nis : null
                };
                state.users.push(newUser);
                showMessage('success', `Pengguna ${fullName} berhasil ditambahkan.`);
            } else {
                const userIndex = state.users.findIndex(u => u.id === userId);
                if (userIndex === -1) return;

                state.users[userIndex].fullName = fullName;
                state.users[userIndex].role = role;
                state.users[userIndex].classId = classId;
                state.users[userIndex].nis = role === 'siswa' ? nis : null;

                // Update password if new password is provided
                if (password) {
                    state.users[userIndex].passwordHash = mockHashPassword(password);
                    showMessage('success', `Password ${fullName} berhasil diubah.`);
                }
                showMessage('success', `Perubahan data pengguna ${fullName} berhasil disimpan.`);
            }

            saveData();
            hideModal();
            renderAdminSection('users');
        };

        const deleteUser = (userId) => {
            const user = state.users.find(u => u.id === userId);
            if (!user) return;

            showModal('Konfirmasi Hapus Pengguna', `
                <p class="mb-4">Apakah Anda yakin ingin menghapus pengguna **${user.fullName} (${getRoleName(user.role)})**? Semua catatan presensi siswa ini akan tetap ada, namun tidak terikat ke akun.</p>
                <button onclick="confirmDeleteUser('${userId}')" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 px-4 rounded-lg mr-2">Ya, Hapus</button>
                <button onclick="hideModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2.5 px-4 rounded-lg">Batal</button>
            `);
        };

        const confirmDeleteUser = (userId) => {
            state.users = state.users.filter(u => u.id !== userId);
            // Optionally, delete their attendance, but let's keep it for history consistency
            saveData();
            hideModal();
            showMessage('info', 'Pengguna berhasil dihapus.');
            renderAdminSection('users');
        };

        // --- Admin Kelas Management ---

        const renderAdminClasses = () => {
            const classRows = state.classes.map(c => {
                const wali = state.users.find(u => u.role === 'wali' && u.classId === c.id);
                const studentCount = state.users.filter(u => u.role === 'siswa' && u.classId === c.id).length;
                return `
                    <tr>
                        <td data-label="ID Kelas" class="font-medium text-gray-800">${c.id}</td>
                        <td data-label="Nama Kelas">${c.name}</td>
                        <td data-label="Wali Kelas">${wali ? wali.fullName : 'Belum Ditugaskan'}</td>
                        <td data-label="Jumlah Siswa">${studentCount}</td>
                        <td data-label="Aksi" class="space-x-2 flex justify-end md:justify-start mt-2 md:mt-0">
                            <button onclick="openEditClassModal('${c.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit Nama</button>
                            <button onclick="deleteClass('${c.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Hapus</button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Daftar Kelas</h3>
                    <button onclick="openEditClassModal(null)" class="mb-4 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 flex items-center space-x-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        <span>Tambah Kelas Baru</span>
                    </button>
                    
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="w-full responsive-table bg-white">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">ID Kelas</th>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Nama Kelas</th>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Wali Kelas</th>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Jml Siswa</th>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${classRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        const openEditClassModal = (classId) => {
            const classObj = state.classes.find(c => c.id === classId) || {};
            const isNew = !classId;
            const title = isNew ? 'Tambah Kelas Baru' : `Edit Kelas: ${classObj.name}`;

            const modalBody = `
                <div class="mb-4">
                    <label for="edit-class-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas (Contoh: Kelas XA)</label>
                    <input type="text" id="edit-class-name" value="${classObj.name || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                ${isNew ? `
                    <div class="mb-4">
                        <label for="edit-class-id" class="block text-sm font-medium text-gray-700 mb-1">ID Kelas (Contoh: c10A - Harus Unik)</label>
                        <input type="text" id="edit-class-id" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                ` : `<p class="text-sm text-gray-500 mb-4">ID Kelas: ${classObj.id}</p>`}
                
                <button onclick="saveClass('${classId}', ${isNew})" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2.5 rounded-lg transition duration-200">
                    ${isNew ? 'Tambah Kelas' : 'Simpan Perubahan'}
                </button>
            `;
            showModal(title, modalBody);
        };
        
        const saveClass = (classId, isNew) => {
            const name = document.getElementById('edit-class-name').value;
            let id = classId;
            
            if (isNew) {
                id = document.getElementById('edit-class-id').value;
            }

            if (!name || !id) {
                showMessage('error', 'Nama dan ID Kelas wajib diisi.');
                return;
            }

            if (isNew) {
                if (state.classes.some(c => c.id === id)) {
                    showMessage('error', 'ID Kelas sudah digunakan.');
                    return;
                }
                state.classes.push({ id, name });
                showMessage('success', `Kelas ${name} berhasil ditambahkan.`);
            } else {
                const index = state.classes.findIndex(c => c.id === id);
                if (index === -1) return;
                state.classes[index].name = name;
                showMessage('success', `Nama Kelas ${name} berhasil diubah.`);
            }

            saveData();
            hideModal();
            renderAdminSection('classes');
        };

        const deleteClass = (classId) => {
            const classObj = state.classes.find(c => c.id === classId);
            const associatedUsers = state.users.filter(u => u.classId === classId);
            if (!classObj) return;
            
            if (associatedUsers.length > 0) {
                 showModal('Gagal Hapus Kelas', `<p class="mb-4">Kelas **${classObj.name}** tidak dapat dihapus karena masih memiliki ${associatedUsers.length} pengguna (Siswa/Wali) yang terkait. Harap ubah data pengguna tersebut terlebih dahulu.</p>`);
                 return;
            }

            showModal('Konfirmasi Hapus Kelas', `
                <p class="mb-4">Apakah Anda yakin ingin menghapus kelas **${classObj.name}**? Tindakan ini tidak dapat dibatalkan.</p>
                <button onclick="confirmDeleteClass('${classId}')" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 px-4 rounded-lg mr-2">Ya, Hapus</button>
                <button onclick="hideModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2.5 px-4 rounded-lg">Batal</button>
            `);
        };

        const confirmDeleteClass = (classId) => {
            state.classes = state.classes.filter(c => c.id !== classId);
            saveData();
            hideModal();
            showMessage('info', 'Kelas berhasil dihapus.');
            renderAdminSection('classes');
        };

        // --- Admin All Attendance Recap ---

        const renderAdminAllAttendance = () => {
            const attendance = state.attendance.sort((a, b) => new Date(b.date) - new Date(a.date));

            const attendanceRows = attendance.map(a => {
                const user = state.users.find(u => u.id === a.userId);
                const classObj = state.classes.find(c => c.id === user?.classId);
                return `
                    <tr>
                        <td data-label="Tanggal" class="font-medium text-gray-800">${a.date}</td>
                        <td data-label="Waktu">${a.time}</td>
                        <td data-label="Nama Siswa">${user?.fullName || 'Pengguna Dihapus'}</td>
                        <td data-label="Kelas">${classObj?.name || '-'}</td>
                        <td data-label="Status">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                a.status === 'Hadir' ? 'bg-emerald-100 text-emerald-800' :
                                a.status === 'Izin' ? 'bg-yellow-100 text-yellow-800' :
                                a.status === 'Sakit' ? 'bg-orange-100 text-orange-800' :
                                'bg-red-100 text-red-800'
                            }">
                                ${a.status}
                            </span>
                        </td>
                        <td data-label="Aksi" class="space-x-2 flex justify-end md:justify-start mt-2 md:mt-0">
                            <button onclick="editSingleRecord('${a.id}', '${user?.fullName || 'Pengguna Dihapus'}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Seluruh Rekap Absensi Sekolah</h3>
                    <p class="text-sm text-gray-500 mb-4">Total ${attendance.length} catatan presensi tersedia di sistem.</p>
                    
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="w-full responsive-table bg-white">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Tanggal</th>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Waktu</th>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Nama Siswa</th>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Kelas</th>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Status</th>
                                    <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-gray-600">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${attendanceRows || '<tr><td colspan="6" class="text-center py-4 text-gray-500 italic">Belum ada catatan presensi.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        // --- Inisialisasi Aplikasi ---

        const initApp = () => {
            loadData();
            checkAuthentication();
            // Optional: for jsPDF autoTable integration
            if (typeof doc === 'object' && typeof doc.autoTable !== 'function') {
                console.warn('jsPDF or autoTable not loaded correctly.');
            }
        };

        window.onload = initApp;

        // Expose functions globally for HTML events
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        window.openCheckinModal = openCheckinModal;
        window.toggleReasonField = toggleReasonField;
        window.handleCheckin = handleCheckin;
        window.renderAdminSection = renderAdminSection;
        window.openEditUserModal = openEditUserModal;
        window.deleteUser = deleteUser;
        window.saveUser = saveUser;
        window.toggleUserFields = toggleUserFields;
        window.hideModal = hideModal;
        window.openEditClassModal = openEditClassModal;
        window.saveClass = saveClass;
        window.deleteClass = deleteClass;
        window.confirmDeleteUser = confirmDeleteUser;
        window.confirmDeleteClass = confirmDeleteClass;
        window.updateWaliFilter = updateWaliFilter;
        window.downloadReport = downloadReport;
        window.openEditAttendanceModal = openEditAttendanceModal;
        window.addAttendanceRecord = addAttendanceRecord;
        window.editSingleRecord = editSingleRecord;
        window.updateAttendanceRecord = updateAttendanceRecord;
        window.deleteSingleRecord = deleteSingleRecord;
        window.confirmDeleteRecord = confirmDeleteRecord;
        
    </script>
</body>
</html>
